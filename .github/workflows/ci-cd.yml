name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================
  # BACKEND JOBS
  # ============================================
  
  backend-lint-test:
    name: Backend - Lint & Test
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'backend/') || github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: ðŸ“¦ Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --break-system-packages
          echo "âœ… Dependencies installed successfully"

      - name: ðŸ” Verify no duplicate dependencies
        working-directory: ./backend
        run: |
          echo "Checking for duplicate apify-client entries..."
          APIFY_COUNT=$(grep -c "^apify-client==" requirements.txt || echo "0")
          if [ "$APIFY_COUNT" -eq "1" ]; then
            echo "âœ… Only one apify-client version found (correct!)"
          elif [ "$APIFY_COUNT" -eq "0" ]; then
            echo "âš ï¸ WARNING: No apify-client found"
          else
            echo "âŒ ERROR: Multiple apify-client versions found ($APIFY_COUNT)"
            grep "^apify-client==" requirements.txt
            exit 1
          fi

      - name: ðŸŽ¨ Lint with flake8
        working-directory: ./backend
        run: |
          pip install flake8
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

  # ============================================
  # FRONTEND JOBS
  # ============================================
  
  frontend-lint-typecheck:
    name: Frontend - Lint & Type Check
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'frontend/') || github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: |
          echo "ðŸ§¹ Cleaning up old dependencies..."
          rm -rf node_modules package-lock.json
          echo "ðŸ“¥ Installing fresh dependencies..."
          npm install
          echo "âœ… Dependencies installed successfully"

      - name: ðŸ” Verify no apify-client
        working-directory: ./frontend
        run: |
          if grep -q "apify-client" package.json; then
            echo "âŒ ERROR: apify-client found in frontend package.json"
            echo "apify-client should only be in backend!"
            exit 1
          fi
          echo "âœ… No apify-client dependency found in frontend (correct!)"

      - name: ðŸŽ¨ Run ESLint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: ðŸ“ TypeScript type check
        working-directory: ./frontend
        run: npm run type-check

  frontend-build:
    name: Frontend - Build
    runs-on: ubuntu-latest
    needs: frontend-lint-typecheck
    if: contains(github.event.head_commit.modified, 'frontend/') || github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: |
          rm -rf node_modules package-lock.json
          npm install

      - name: ðŸ—ï¸ Build Next.js app
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8000' }}
        run: |
          echo "ðŸ—ï¸ Building production bundle..."
          npm run build
          echo "âœ… Build completed successfully"

      - name: ðŸ“Š Bundle size analysis
        working-directory: ./frontend
        run: |
          echo "ðŸ“¦ Bundle size:"
          du -sh .next/ 2>/dev/null || echo "Build folder size: N/A"

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4  # âœ… FIXED: Updated to v4
        with:
          name: frontend-build
          path: frontend/.next/
          retention-days: 7
          compression-level: 6

  # ============================================
  # DEPLOYMENT JOBS
  # ============================================
  
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: backend-lint-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Render
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "ðŸš€ Triggering Render deployment..."
            curl -X POST "$RENDER_DEPLOY_HOOK_URL"
            echo "âœ… Backend deployment triggered"
          else
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL not set"
            echo "ðŸ’¡ Add it to GitHub Secrets to enable auto-deployment"
          fi

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: frontend-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod'
        if: ${{ secrets.VERCEL_TOKEN != '' }}

      - name: âš ï¸ Vercel not configured
        if: ${{ secrets.VERCEL_TOKEN == '' }}
        run: |
          echo "âš ï¸ Vercel secrets not configured"
          echo "ðŸ’¡ Add VERCEL_TOKEN, VERCEL_ORG_ID, and VERCEL_PROJECT_ID to GitHub Secrets"

  # ============================================
  # PREVIEW DEPLOYMENT (Pull Requests)
  # ============================================
  
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [frontend-build]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy Preview to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
        if: ${{ secrets.VERCEL_TOKEN != '' }}

      - name: ðŸ’¬ Comment preview URL
        uses: actions/github-script@v7
        if: ${{ secrets.VERCEL_TOKEN != '' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Preview deployment ready! Check the deployment URL above.'
            })

  # ============================================
  # NOTIFICATION JOB
  # ============================================
  
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [backend-lint-test, frontend-build, deploy-backend, deploy-frontend]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: âœ… Success notification
        if: ${{ needs.backend-lint-test.result == 'success' && needs.frontend-build.result == 'success' }}
        run: |
          echo "ðŸŽ‰ All CI/CD jobs completed successfully!"
          echo ""
          echo "âœ… Backend: Lint & Test - Passed"
          echo "âœ… Frontend: Lint, Type Check & Build - Passed"
          echo "âœ… Backend Deployment: ${{ needs.deploy-backend.result }}"
          echo "âœ… Frontend Deployment: ${{ needs.deploy-frontend.result }}"

      - name: âŒ Failure notification
        if: ${{ needs.backend-lint-test.result == 'failure' || needs.frontend-build.result == 'failure' }}
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Build**: ${{ needs.backend-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Build**: ${{ needs.frontend-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
